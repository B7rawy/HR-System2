import React, { createContext, useContext, useState, useEffect } from 'react'

const ThemeContext = createContext()

export const useTheme = () => {
  const context = useContext(ThemeContext)
  if (!context) {
    throw new Error('useTheme must be used within a ThemeProvider')
  }
  return context
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… ÙÙˆØ±Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø±Ù†Ø¯Ø± Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ÙˆÙ…ÙŠØ¶
const getInitialTheme = () => {
  if (typeof window !== 'undefined') {
    const savedTheme = localStorage.getItem('theme')
    if (savedTheme) {
      return savedTheme === 'dark'
    }
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
    return window.matchMedia('(prefers-color-scheme: dark)').matches
  }
  return false
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙ†Ø¯
const applyTheme = (isDark) => {
  if (typeof window !== 'undefined') {
    if (isDark) {
      document.documentElement.classList.add('dark')
      localStorage.setItem('theme', 'dark')
    } else {
      document.documentElement.classList.remove('dark')
      localStorage.setItem('theme', 'light')
    }
  }
}

export const ThemeProvider = ({ children }) => {
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø£ÙˆÙ„ÙŠ
  const [isDarkMode, setIsDarkMode] = useState(() => {
    const initialTheme = getInitialTheme()
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… ÙÙˆØ±Ø§Ù‹
    applyTheme(initialTheme)
    return initialTheme
  })

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  useEffect(() => {
    const savedTheme = localStorage.getItem('theme')
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
    
    let shouldBeDark = false
    
    if (savedTheme) {
      shouldBeDark = savedTheme === 'dark'
    } else {
      shouldBeDark = prefersDark
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ØªÙ„ÙØ§Ù‹
    if (shouldBeDark !== isDarkMode) {
      setIsDarkMode(shouldBeDark)
      applyTheme(shouldBeDark)
    }
  }, [])

  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
  useEffect(() => {
    applyTheme(isDarkMode)
  }, [isDarkMode])

  // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
    
    const handleChange = (e) => {
      // ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªÙØ¶ÙŠÙ„ Ù…Ø­ÙÙˆØ¸
      const savedTheme = localStorage.getItem('theme')
      if (!savedTheme) {
        setIsDarkMode(e.matches)
      }
    }
    
    mediaQuery.addEventListener('change', handleChange)
    return () => mediaQuery.removeEventListener('change', handleChange)
  }, [])

  const toggleTheme = () => {
    const newTheme = !isDarkMode
    setIsDarkMode(newTheme)
    applyTheme(newTheme)
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    console.log(`ğŸ¨ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø«ÙŠÙ… Ø¥Ù„Ù‰: ${newTheme ? 'Ø§Ù„Ù…Ø¸Ù„Ù…' : 'Ø§Ù„ÙØ§ØªØ­'}`)
    console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„ ÙÙŠ localStorage: ${newTheme ? 'dark' : 'light'}`)
    
    // Ø¥Ø´Ø¹Ø§Ø± Ø¨ØµØ±ÙŠ Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if (typeof window !== 'undefined') {
      // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© toast notification Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
    }
  }

  const value = {
    isDarkMode,
    toggleTheme,
    theme: isDarkMode ? 'dark' : 'light'
  }

  return (
    <ThemeContext.Provider value={value}>
      {children}
    </ThemeContext.Provider>
  )
}

export default ThemeContext 