name: Deploy to Hostinger VPS

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies - Backend
      run: |
        cd backend
        npm install
        
    - name: Install dependencies - Frontend
      run: |
        cd frontend
        npm install
        
    - name: Build Frontend
      run: |
        cd frontend
        npm run build
        
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: 109.176.199.143
        username: admin
        password: ${{ secrets.VPS_PASSWORD }}
        script: |
          # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…
          sudo apt update
          
          # ØªÙ†ØµÙŠØ¨ Node.js Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø«Ø¨Øª
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # ØªÙ†ØµÙŠØ¨ PM2
          if ! command -v pm2 &> /dev/null; then
            sudo npm install -g pm2
          fi
          
          # ØªÙ†ØµÙŠØ¨ Nginx
          if ! command -v nginx &> /dev/null; then
            sudo apt install nginx -y
            sudo systemctl enable nginx
          fi
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
          sudo mkdir -p /var/www/hr-system
          cd /var/www/hr-system
          
          # Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
          sudo rm -rf *
          
          # Ù†Ø³Ø® Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† GitHub
          sudo git clone https://github.com/B7rawy/HR-System.git .
          
          # ØªÙ†ØµÙŠØ¨ dependencies Ù„Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
          cd backend
          sudo npm install --production
          
          # ØªÙ†ØµÙŠØ¨ dependencies Ù„Ù„ÙØ±ÙˆÙ†Øª Ø¥Ù†Ø¯
          cd ../frontend
          sudo npm install
          sudo npm run build
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ PM2 Ù„Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
          cd ../backend
          sudo pm2 delete hr-backend || true
          sudo pm2 start server.js --name hr-backend
          sudo pm2 save
          sudo pm2 startup
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Nginx Ù„Ù„ÙØ±ÙˆÙ†Øª Ø¥Ù†Ø¯
          sudo tee /etc/nginx/sites-available/hr-system > /dev/null <<EOF
          server {
              listen 80;
              server_name 109.176.199.143;
              
              # Frontend files
              location / {
                  root /var/www/hr-system/frontend/build;
                  index index.html;
                  try_files \$uri \$uri/ /index.html;
              }
              
              # Backend API
              location /api/ {
                  proxy_pass http://localhost:5001/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_cache_bypass \$http_upgrade;
              }
          }
          EOF
          
          # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
          sudo ln -sf /etc/nginx/sites-available/hr-system /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t && sudo systemctl restart nginx
          
          echo "ðŸŽ‰ ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ØªØ§Ø­ Ø¹Ù„Ù‰ http://109.176.199.143" 